<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üçΩÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –µ–¥–µ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input { margin: 5px; }
    button { margin: 5px; }
    table { border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; }
    th { background: #f0f0f0; cursor: pointer; }
    #meta { margin-top: 10px; color: #555; }
  </style>
</head>
<body>
<h1>üçΩÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å –ø–æ –µ–¥–µ</h1>

<div>
  <label>–ú–∞–∫—Å. –∫–∞–ª–æ—Ä–∏–π:
    <input id="max_cal" type="number" value="400">
  </label>
  <label>–ú–∏–Ω. –±–µ–ª–∫–∞:
    <input id="min_prot" type="number" value="20">
  </label>
  <label>–°–∫–æ–ª—å–∫–æ –±–ª—é–¥:
    <input id="top_n" type="number" value="5">
  </label>
</div>

<div>
  <button onclick="presetDiet()">–î–∏–µ—Ç–∞</button>
  <button onclick="presetMass()">–ú–∞—Å—Å–∞</button>
  <button onclick="presetSnack()">–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–∫—É—Å</button>
  <button onclick="loadRecs()">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
</div>

<div>
  <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:
    <input id="search" type="text" oninput="applySearch()">
  </label>
</div>

<div id="meta"></div>
<div id="out"></div>

<script>
let lastData = [];

function presetDiet() {
  document.getElementById('max_cal').value = 400;
  document.getElementById('min_prot').value = 20;
  document.getElementById('top_n').value = 10;
  loadRecs();
}

function presetMass() {
  document.getElementById('max_cal').value = 800;
  document.getElementById('min_prot').value = 30;
  document.getElementById('top_n').value = 10;
  loadRecs();
}

function presetSnack() {
  document.getElementById('max_cal').value = 300;
  document.getElementById('min_prot').value = 10;
  document.getElementById('top_n').value = 5;
  loadRecs();
}

async function loadRecs() {
  const max_cal = document.getElementById('max_cal').value || 9999;
  const min_prot = document.getElementById('min_prot').value || 0;
  const top_n = document.getElementById('top_n').value || 5;

  const url = `/recommend?max_calories=${max_cal}&min_protein=${min_prot}&top_n=${top_n}`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data.dishes || data.dishes.length === 0) {
    document.getElementById('out').innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
    document.getElementById('meta').innerHTML = '';
    lastData = [];
    return;
  }

  lastData = data.dishes;
  document.getElementById('meta').innerText =
    `–ù–∞–π–¥–µ–Ω–æ ${data.count} –±–ª—é–¥. –§–∏–ª—å—Ç—Ä—ã: ` +
    `max_cal=${max_cal}, min_prot=${min_prot}.`;

  renderTable(lastData);
}

function renderTable(rows) {
  let html = '<table><tr>' +
    '<th onclick="sortBy(\'title\')">–ë–ª—é–¥–æ</th>' +
    '<th onclick="sortBy(\'calories\')">–ö–∫–∞–ª</th>' +
    '<th onclick="sortBy(\'protein\')">–ë–µ–ª–æ–∫</th>' +
    '<th onclick="sortBy(\'fat\')">–ñ–∏—Ä</th>' +
    '<th onclick="sortBy(\'sodium\')">–°–æ–ª—å</th>' +
    '<th onclick="sortBy(\'score\')">–°—á—ë—Ç</th>' +
    '</tr>';

  rows.forEach(d => {
    html += `<tr>
      <td>${d.title}</td>
      <td>${d.calories}</td>
      <td>${d.protein}</td>
      <td>${d.fat}</td>
      <td>${d.sodium}</td>
      <td>${(d.score * 100).toFixed(0)}%</td>
    </tr>`;
  });

  html += '</table>';
  document.getElementById('out').innerHTML = html;
}

let sortState = { field: 'score', asc: false };

function sortBy(field) {
  if (sortState.field === field) {
    sortState.asc = !sortState.asc;
  } else {
    sortState.field = field;
    sortState.asc = field !== 'score'; // score –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ —É–±—ã–≤–∞–Ω–∏—é
  }
  const sorted = [...lastData].sort((a, b) => {
    const av = a[field];
    const bv = b[field];
    if (av < bv) return sortState.asc ? -1 : 1;
    if (av > bv) return sortState.asc ? 1 : -1;
    return 0;
  });
  renderTable(sorted);
}

function applySearch() {
  const q = document.getElementById('search').value.toLowerCase();
  const filtered = lastData.filter(d => d.title.toLowerCase().includes(q));
  renderTable(filtered);
}

// –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞
loadRecs();
</script>
</body>
</html>

